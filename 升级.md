---
title: 升级 Rancher
layout: rancher-default
---

## 升级Rancher
---

如果你运行 Rancher 服务端时 **没有** 使用 [外部数据库]({{site.baseurl}}/rancher/installing-rancher/installing-server/#external-db), Rancher 服务端数据库在你的 Rancher 服务端容器内. 我们将要使用运行中的 Rancher 服务端容器来创建一个数据容器. 数据容器将会通过使用 `--volumes-from` 以用来启动新的 Rancher 服务端. 或者, 你能将数据库从容器中拷贝出来到主机的某个目录然后绑定挂载数据库.

> **注意:** 如果你使用了外部数据库, 你能停止原始的 Rancher 服务端容器然后使用相同的[外部数据库指引]({{site.baseurl}}/rancher/installing-rancher/installing-server/#external-db)来启动新版本的 Rancher 服务端.在新服务端启动运行后,你就能删除老的 Rancher 服务端容器了. 注意: 如果你仅停止容器,如果你的机器重启,容器将会由于有`--restart=always`而重新运行.


#### 通过创建数据容器升级 Rancher

1. 停止容器.

   ```bash
   $ docker stop <container_name_of_original_server>
   ```

2. 创建一个 `rancher-data` 容器. 注意: 此步骤可以跳过,如果你过去已经升级过并且已经有了一个 `rancher-data` 容器.
    
   ```bash
   $ docker create --volumes-from <container_name_of_original_server> \
    --name rancher-data rancher/server:<tag_of_previous_rancher_server>
   ```

3. 拉取最近的 Rancher 服务端镜像. 注意: 如果你跳过此步骤然后尝试运行`最近的`镜像, 将不会自动拉取更新后的镜像.

   ```bash
   $ docker pull rancher/server:latest
   ```

   
4. Launch a new Rancher Server container using the database from the `rancher-data` container. Any changes in Rancher will be saved in the `rancher-data` container. If you seen an exception in the server regarding a log lock, please refer to [how to fix the log lock]({{site.baseurl}}/rancher/faqs/server/#databaselock).
4. Launch a new Rancher Server container using the database from the `rancher-data` container. Any changes in Rancher will be saved in the `rancher-data` container. If you seen an exception in the server regarding a log lock, please refer to [how to fix the log lock]({{site.baseurl}}/rancher/faqs/server/#databaselock).

    
    > **Note**: Depending on how long you've had Rancher server, certain database migrations may take longer than expected. Please do not stop upgrades in the middle of upgrading as you will hit a database migration error the next time you upgrade.

   ```bash
   $ docker run -d --volumes-from rancher-data --restart=always \
     -p 8080:8080 rancher/server:latest
   ```

    > **Note:** If you set any environment variables or passed in a [ldap certificate]({{site.baseurl}}/rancher/installing-rancher/installing-server/#enabling-active-directory-or-openldap-for-tls) in your original Rancher server setup, you'll need to add those environment variables or certificate in the command. 

5. Remove the old Rancher server container. Note: If you only stop the container, the container will be restarted if your machine is rebooted due to the `--restart=always`. We recommend removing the container after your upgrade has been successful.

#### Upgrading Rancher launched using Bind Mounts

1. Stop the running Rancher Server container.

   ```bash
   $ docker stop <container_name_of_original_server>
   ```

2. Copy the database files out of the server container. Note: If you already have the database stored on the host, you can skip this step. Also, if the DB has been copied out of the container, it will be inside /<path>/mysql/ because of the way Docker copies it out. Be sure to account for this when bind mounting into the container. If you started with bind mounts, you will not need the mysql/.

   ```bash
   $ docker cp <container_name_of_original_server>:/var/lib/mysql <path on host>
   ```

3. Now set the UID/GID for the folder so that the mysql user within the container has the correct ownership of the mysql mount.

   ```bash
   $ sudo chown -R 102:105 <path on host>
   ```

4. Start new server container.

   ```bash
   $ docker run -d -v <path_on_host>:/var/lib/mysql -p 8080:8080 \
     --restart=always rancher/server:latest
   ```
  <br>

   > **Note:** It is important that you have trailing '/' at the end of the host path if you have copied a database out of a previous container. Otherwise, the directory ends up in the wrong place.

### Rancher Agents 

Each Rancher agent version is pinned to a Rancher server version. If you upgrade Rancher server and Rancher agents require an upgrade, it will automatically upgrade the agents to the latest version of Rancher agent. 

For anything using the `rancher/agent-instance` image, the running container gets upgraded even if the image of the container is not updated to the latest version. For the _Network Agent_, this occurs when there is a trigger regarding networking (e.g. adding another container, deleting a container). For the _Load Balancers_, the upgrade occurs by the next load balancer configuration update (e.g. target instance gets restarted, new target service is added, hostname routing rules change, load balacner instance restart, etc).

#### Users with No Internet Access

Users without internet will need to download the latest `rancher/agent-instance` into their own registry. In order to upgrade the version of the network agent, you’d need to manually stop the network agent and remove from the UI. Anything that triggers networking on the host that has the missing network agent will cause a new network agent (with the latest version) to be started. In order to upgrade the version of your load balancers, you’ll need to re-create them to get the newest version of `rancher/agent-instance`. 